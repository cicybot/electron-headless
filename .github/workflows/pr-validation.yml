name: PR Validation and Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

env:
  GH_TOKEN: ${{ secrets.GH_CICYBOT_TOKEN }}

jobs:
  validate:
    name: Validate Changes
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install backend dependencies
      run: |
        cd app
        npm ci
        
    - name: Install frontend dependencies
      run: |
        cd render
        npm ci
        
    - name: Run backend tests
      run: |
        cd app
        npm test
        
    - name: Run frontend linting
      run: |
        cd render
        npm run lint
        
    - name: Check backend formatting
      run: |
        cd app
        npm run format:check
        
    - name: Build frontend
      run: |
        cd render
        npm run build
        
    - name: Build backend
      run: |
        cd app
        npm run build

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run npm audit
      run: |
        cd app && npm audit --audit-level moderate
        cd ../render && npm audit --audit-level moderate

  changelog-check:
    name: Changelog Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check for changelog updates
      run: |
        # Check if changelog has been updated in this PR
        if git diff --name-only origin/main HEAD | grep -q "app/changelog/"; then
          echo "✅ Changelog has been updated"
        else
          echo "❌ Changelog not updated. Please update app/changelog/current.md"
          exit 1
        fi

  auto-approve:
    name: Auto Approve
    runs-on: ubuntu-latest
    needs: [validate, security-scan, changelog-check]
    if: github.actor == 'opencode' || github.actor == 'github-actions[bot]'
    
    steps:
    - name: Auto approve PR
      run: |
        gh pr review --approve "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GH_TOKEN: ${{ secrets.GH_CICYBOT_TOKEN }}

  auto-merge:
    name: Auto Merge
    runs-on: ubuntu-latest
    needs: [validate, security-scan, changelog-check, auto-approve]
    if: github.actor == 'opencode' || github.actor == 'github-actions[bot]'
    
    steps:
    - name: Auto merge PR
      run: |
        gh pr merge --merge --auto "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GH_TOKEN: ${{ secrets.GH_CICYBOT_TOKEN }}

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [validate, security-scan, changelog-check]
    if: always()
    
    steps:
    - name: Comment on PR
      run: |
        if [ "${{ needs.validate.result }}" == "success" ] && [ "${{ needs.security-scan.result }}" == "success" ] && [ "${{ needs.changelog-check.result }}" == "success" ]; then
          gh pr comment "$PR_URL" --body "✅ **All checks passed!**
          
          - Backend tests: ✅ PASSED
          - Frontend linting: ✅ PASSED  
          - Code formatting: ✅ PASSED
          - Security scan: ✅ PASSED
          - Changelog updated: ✅ PASSED
          
          This PR is ready for merge."
        else
          gh pr comment "$PR_URL" --body "❌ **Some checks failed!**
          
          Please review the failed checks and fix the issues:
          - Backend tests: ${{ needs.validate.result }}
          - Frontend linting: ${{ needs.validate.result }}
          - Code formatting: ${{ needs.validate.result }}
          - Security scan: ${{ needs.security-scan.result }}
          - Changelog updated: ${{ needs.changelog-check.result }}"
        fi
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GH_TOKEN: ${{ secrets.GH_CICYBOT_TOKEN }}